import{o as e}from"./rolldown-runtime-BgAqdD8a.js";import{a as t,r as s}from"./motion-Q_hw2Ya2.js";import{N as a,Q as r,X as i,a as n,gt as c,i as l,n as o,o as d,r as m,st as u,tt as p,u as x,vt as h,z as y}from"./vendor-D_eNeWdO.js";import{a as g,o as f}from"./i18n-PYB7o98L.js";import{c as j,i as b,r as v}from"./index-CSH1YS6q.js";import{t as N}from"./useAuth-CQSRYPa0.js";var k=e(t(),1),w=s(),_=({onPaymentSuccess:e,onPaymentError:t,isProcessing:s,setIsProcessing:a})=>{const r=n(),i=l();return(0,w.jsxs)("form",{onSubmit:(c=h((function*(s){if(s.preventDefault(),r&&i){a(!0);try{const{error:s,paymentIntent:a}=yield r.confirmPayment({elements:i,redirect:"if_required"});s?t(s.message):a&&"succeeded"===a.status?e(a):t("Une erreur inattendue est survenue.")}catch(n){t(n.message||"Payment failed")}finally{a(!1)}}})),function(e){return c.apply(this,arguments)}),className:"space-y-6",children:[(0,w.jsx)("div",{className:"card p-5 border border-gray-200",children:(0,w.jsx)(m,{})}),(0,w.jsx)("button",{type:"submit",disabled:s||!r||!i,className:"btn btn-primary w-full flex justify-center items-center",children:s?(0,w.jsxs)("span",{className:"flex items-center",children:[(0,w.jsxs)("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,w.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,w.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Traitement en cours..."]}):"Payer maintenant"})]});var c};f();var C=()=>{const{t:e}=u(),t=c(),{cartItems:s,clearCart:n}=b(),{user:l}=N(),{formatPrice:m}=v(),[f,C]=(0,k.useState)({address:"",city:"",postalCode:"",country:""}),[P,S]=(0,k.useState)("PayPal"),[q,F]=(0,k.useState)(1),[z,A]=(0,k.useState)(null),[I,D]=(0,k.useState)(""),[E,M]=(0,k.useState)(!1),W=e=>{if(!e)return"";const t=e.toLowerCase();return t.startsWith("http")||t.startsWith("data:")||t.startsWith("/")?e:`/images/${e}`};(0,k.useEffect)((()=>{var e;l||t("/login?redirect=/checkout"),0===s.length&&t("/cart"),(e=h((function*(){const{data:e}=yield j.get("/payment/config");A(d(e.publishableKey))})),function(){return e.apply(this,arguments)})()}),[l,s,t]);const $=s.reduce(((e,t)=>e+t.qty*t.price),0),B=$+0+0;(0,k.useEffect)((()=>{var t;3===q&&"Stripe"===P&&!I&&B>0&&(t=h((function*(){try{const e={headers:{"Content-Type":"application/json",Authorization:`Bearer ${l.token}`}},{data:t}=yield j.post("/payment/create-payment-intent",{amount:B},e);D(t.clientSecret)}catch(s){var t;x.error((null===(t=s.response)||void 0===t||null===(t=t.data)||void 0===t?void 0:t.message)||e("checkout.errors.payment_init_failed"))}})),function(){return t.apply(this,arguments)})()}),[q,P,B,l.token,I]);const T=(H=h((function*(a={}){try{const r={headers:{"Content-Type":"application/json",Authorization:`Bearer ${l.token}`}},i={orderItems:s.map((e=>({product:e._id,name:e.name,image:e.image,price:e.price,qty:e.qty}))),shippingAddress:f,paymentMethod:P,itemsPrice:$.toFixed(2),taxPrice:(0).toFixed(2),shippingPrice:(0).toFixed(2),totalPrice:B.toFixed(2),paymentResult:a,isPaid:"Stripe"===P&&("succeeded"===a.status||"requires_capture"===a.status),paidAt:"Stripe"!==P||"succeeded"!==a.status&&"requires_capture"!==a.status?null:new Date},{data:c}=yield j.post("/orders",i,r);n(),x.success(e("checkout.success.order_placed")),t(`/order-success/${c._id}`)}catch(i){var r;x.error((null===(r=i.response)||void 0===r||null===(r=r.data)||void 0===r?void 0:r.message)||e("checkout.errors.order_failed"))}})),function(){return H.apply(this,arguments)});var H;return(0,w.jsxs)("div",{className:"container mx-auto px-4 py-12",children:[(0,w.jsx)("h1",{className:"text-4xl font-serif text-gray-900 mb-10 text-center",children:"Checkout"}),(0,w.jsxs)("div",{className:"max-w-4xl mx-auto card-strong p-8 ring-1 ring-transparent hover:ring-primary/20 transition-all",children:[(0,w.jsxs)("div",{className:"flex justify-between items-center mb-10 relative",children:[(0,w.jsx)("div",{className:"absolute left-0 right-0 top-1/2 -translate-y-1/2 h-1 bg-gray-200 rounded-full",children:(0,w.jsx)("div",{className:"h-full bg-primary transition-all duration-500 ease-in-out rounded-full",style:{width:(q-1)/2*100+"%"}})}),[1,2,3].map((t=>(0,w.jsxs)("div",{className:"relative z-10 flex flex-col items-center",children:[(0,w.jsx)("div",{className:"w-10 h-10 rounded-full ring-2 ring-white shadow flex items-center justify-center text-white font-bold text-lg transition-all duration-300 "+(q>=t?"bg-primary":"bg-gray-300"),children:q>t?(0,w.jsx)(r,{size:20}):t}),(0,w.jsxs)("span",{className:"mt-2 text-sm font-medium "+(q>=t?"text-primary":"text-gray-500"),children:[1===t&&e("checkout.steps.shipping"),2===t&&e("checkout.steps.payment"),3===t&&e("checkout.steps.place_order")]})]},t)))]}),(0,w.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-10",children:[(0,w.jsxs)("div",{className:"lg:col-span-2",children:[1===q&&(0,w.jsxs)("form",{onSubmit:e=>{e.preventDefault(),F(2)},className:"space-y-6",children:[(0,w.jsxs)("h2",{className:"text-2xl font-serif text-gray-800 mb-6 flex items-center",children:[(0,w.jsx)(y,{className:"mr-3"})," ",e("checkout.shipping.title")]}),(0,w.jsxs)("div",{children:[(0,w.jsx)("label",{htmlFor:"address",className:"block text-sm font-medium text-gray-700 mb-2",children:e("checkout.shipping.address_label")}),(0,w.jsx)("input",{type:"text",id:"address",className:"input",value:f.address,onChange:e=>C(g(g({},f),{},{address:e.target.value})),required:!0})]}),(0,w.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,w.jsxs)("div",{children:[(0,w.jsx)("label",{htmlFor:"city",className:"block text-sm font-medium text-gray-700 mb-2",children:e("checkout.shipping.city_label")}),(0,w.jsx)("input",{type:"text",id:"city",className:"input",value:f.city,onChange:e=>C(g(g({},f),{},{city:e.target.value})),required:!0})]}),(0,w.jsxs)("div",{children:[(0,w.jsx)("label",{htmlFor:"postalCode",className:"block text-sm font-medium text-gray-700 mb-2",children:e("checkout.shipping.postal_code_label")}),(0,w.jsx)("input",{type:"text",id:"postalCode",className:"input",value:f.postalCode,onChange:e=>C(g(g({},f),{},{postalCode:e.target.value})),required:!0})]})]}),(0,w.jsxs)("div",{children:[(0,w.jsx)("label",{htmlFor:"country",className:"block text-sm font-medium text-gray-700 mb-2",children:e("checkout.shipping.country_label")}),(0,w.jsx)("input",{type:"text",id:"country",className:"input",value:f.country,onChange:e=>C(g(g({},f),{},{country:e.target.value})),required:!0})]}),(0,w.jsx)("button",{type:"submit",className:"btn btn-primary w-full",children:e("checkout.shipping.continue_btn")})]}),2===q&&(0,w.jsxs)("form",{onSubmit:e=>{e.preventDefault(),F(3)},className:"space-y-6",children:[(0,w.jsxs)("h2",{className:"text-2xl font-serif text-gray-800 mb-6 flex items-center",children:[(0,w.jsx)(i,{className:"mr-3"})," ",e("checkout.payment.title")]}),(0,w.jsxs)("div",{className:"space-y-4",children:[(0,w.jsxs)("div",{className:"flex items-center",children:[(0,w.jsx)("input",{type:"radio",id:"paypal",name:"paymentMethod",value:"PayPal",checked:"PayPal"===P,onChange:e=>S(e.target.value),className:"h-4 w-4 text-primary focus:ring-primary border-gray-300"}),(0,w.jsx)("label",{htmlFor:"paypal",className:"ml-3 block text-base font-medium text-gray-700",children:e("checkout.payment.paypal")})]}),(0,w.jsxs)("div",{className:"flex items-center",children:[(0,w.jsx)("input",{type:"radio",id:"stripe",name:"paymentMethod",value:"Stripe",checked:"Stripe"===P,onChange:e=>S(e.target.value),className:"h-4 w-4 text-primary focus:ring-primary border-gray-300"}),(0,w.jsx)("label",{htmlFor:"stripe",className:"ml-3 block text-base font-medium text-gray-700",children:e("checkout.payment.stripe")})]})]}),(0,w.jsxs)("div",{className:"flex justify-between gap-4",children:[(0,w.jsxs)("button",{type:"button",onClick:()=>F(1),className:"btn btn-soft w-1/2",children:[(0,w.jsx)(p,{className:"mr-2",size:20})," ",e("checkout.payment.back_btn")]}),(0,w.jsx)("button",{type:"submit",className:"btn btn-primary w-1/2",children:e("checkout.payment.continue_btn")})]})]}),3===q&&(0,w.jsxs)("div",{className:"space-y-6",children:[(0,w.jsxs)("h2",{className:"text-2xl font-serif text-gray-800 mb-6 flex items-center",children:[(0,w.jsx)(a,{className:"mr-3"})," ",e("checkout.review.title")]}),(0,w.jsxs)("div",{className:"card p-5",children:[(0,w.jsx)("h3",{className:"text-xl font-medium text-gray-800 mb-3",children:e("checkout.review.shipping_info")}),(0,w.jsxs)("p",{className:"text-gray-600",children:[f.address,", ",f.city,", ",f.postalCode,", ",f.country]})]}),(0,w.jsxs)("div",{className:"card p-5",children:[(0,w.jsx)("h3",{className:"text-xl font-medium text-gray-800 mb-3",children:e("checkout.review.payment_method")}),(0,w.jsx)("p",{className:"text-gray-600",children:P})]}),(0,w.jsxs)("div",{className:"card p-5",children:[(0,w.jsx)("h3",{className:"text-xl font-medium text-gray-800 mb-3",children:e("checkout.review.order_items")}),s.map((e=>(0,w.jsxs)("div",{className:"flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0",children:[(0,w.jsxs)("div",{className:"flex items-center",children:[(0,w.jsx)("div",{className:"w-12 h-12 bg-gradient-to-br from-gray-50 to-gray-100 rounded-md flex items-center justify-center shadow-inner mr-3",children:(0,w.jsx)("img",{src:W(e.image),alt:e.name,className:"w-10 h-10 object-contain transition-all duration-300 hover:scale-105"})}),(0,w.jsxs)("span",{className:"text-gray-700 text-sm",children:[e.name," x ",e.qty]})]}),(0,w.jsx)("span",{className:"text-gray-800 font-medium",children:m(e.qty*e.price)})]},e._id)))]}),(0,w.jsxs)("div",{className:"flex justify-between gap-4",children:[(0,w.jsxs)("button",{type:"button",onClick:()=>F(2),className:"btn btn-soft w-1/2",children:[(0,w.jsx)(p,{className:"mr-2",size:20})," ",e("checkout.review.back_btn")]}),"Stripe"===P?I&&z?(0,w.jsx)("div",{className:"w-full",children:(0,w.jsx)(o,{stripe:z,options:{clientSecret:I},children:(0,w.jsx)(_,{onPaymentSuccess:e=>{T({id:e.id,status:e.status,update_time:(new Date).toISOString(),email_address:e.receipt_email})},onPaymentError:e=>{x.error(e)},isProcessing:E,setIsProcessing:M})})}):(0,w.jsx)("div",{className:"w-full flex justify-center py-4",children:(0,w.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):(0,w.jsx)("button",{type:"button",onClick:()=>T({}),className:"btn btn-primary w-1/2",children:e("checkout.review.place_order_btn")})]})]})]}),(0,w.jsx)("div",{className:"lg:col-span-1",children:(0,w.jsxs)("div",{className:"card p-6 sticky top-24 ring-1 ring-transparent hover:ring-primary/20 transition-all",children:[(0,w.jsx)("h2",{className:"text-xl font-serif font-bold text-gray-900 mb-6",children:e("checkout.summary.title")}),(0,w.jsxs)("div",{className:"space-y-3 mb-6",children:[(0,w.jsxs)("div",{className:"flex justify-between text-gray-600",children:[(0,w.jsx)("span",{children:e("checkout.summary.items")}),(0,w.jsx)("span",{children:m($)})]}),(0,w.jsxs)("div",{className:"border-t border-gray-200 pt-4 flex justify-between font-bold text-lg text-gray-900",children:[(0,w.jsx)("span",{children:e("checkout.summary.total")}),(0,w.jsx)("span",{children:m(B)})]})]})]})})]})]})]})};export{C as default};